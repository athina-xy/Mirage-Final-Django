{% extends "core/layout.html" %}

{% block title %}Dashboard ‚Äì Mirage Store{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="page-title">
        Welcome to your own reality, {{ request.user.username }} !
    </h1>
    <p class="page-subtitle">
        This is your own Mirage dashboard. <br>
        Here you can see items you have added to your "üõí Cart" and your "‚ô• Wishlist",
        as well as your most recent orders.
    </p>

    {# Cart #}
    <h2 class="h5 mt-4">üõí Your Cart üõí</h2>

    {% if cart_items %}
        <div class="table-responsive mt-2 mb-3">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Reality</th>
                        <th>Rarity</th>
                        <th class="text-end">Price (‚Ç¨)</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Line Total (‚Ç¨)</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in cart_items %}
                    <tr>
                        <td>{{ row.item.label }}</td>
                        <td>{{ row.item.reality_fragment|default:"‚Äì" }}</td>
                        <td>{{ row.item.get_rarity_display }}</td>
                        <td class="text-end">{{ row.item.price }}</td>
                        <td class="text-center">{{ row.quantity }}</td>
                        <td class="text-end">{{ row.line_total }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="5" class="text-end">Total:</th>
                        <th class="text-end">‚Ç¨{{ cart_total }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'view_cart' %}" class="btn btn-outline-light btn-sm">
                Open full cart
            </a>
            <form method="post" action="{% url 'checkout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">
                    Proceed to Checkout
                </button>
            </form>
        </div>
    {% else %}
        <p class="small mt-2">
            You haven‚Äôt added anything to your cart yet.
            Browse the store and click ‚ÄúAdd üõí‚Äù to start filling it.
        </p>
    {% endif %}

    {# Wishlist #}
    <h2 class="h5 mt-4">‚ô• Wishlisted items ‚ô•</h2>

    {% if wishlist_items %}
        <ul class="list-group mt-2">
            {% for w in wishlist_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ w.item.label }}</span>
                    <span class="text-muted small">‚Ç¨{{ w.item.price }}</span>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="small mt-2">
            You haven‚Äôt added anything to your wishlist yet.
            Browse the store and click ‚Äú‚ô• Wishlist‚Äù to save items here.
        </p>
    {% endif %}

    {# --- Recent orders --- #}
    <h2 class="h5 mt-4">‚úé·ù∞. Recent Orders</h2>

    {% if orders %}
        <div class="table-responsive mt-2">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th class="text-end">Total (‚Ç¨)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for order in orders %}
                    <tr>
                        <td>
                            <a href="{% url 'order_detail' order.id %}">
                                #{{ order.id }}
                            </a>
                        </td>
                        <td class="text-muted small">
                            {{ order.created_at|date:"Y-m-d H:i" }}
                        </td>
                        <td>{{ order.status|title }}</td>
                        <td class="text-end">{{ order.total_price }}</td>
                        <td class="text-end">
                            <a href="{% url 'order_detail' order.id %}"
                               class="btn btn-sm btn-outline-light">
                                View
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="small mt-2">
            You have not placed any orders yet.
            When you complete a checkout, they will appear here.
        </p>
    {% endif %}
</div>
{% endblock %}
